name: üöÄ Deploy Completo (FTP + SSH Migrations)

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: üéâ Deploy Production
    runs-on: ubuntu-latest
    
    steps:
      # 1. Baixa o c√≥digo
      - name: üöö Get latest code
        uses: actions/checkout@v4

      # 2. Configura o PHP (no GitHub Actions)
      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo_mysql

      # 3. Cache do Composer (Acelera o deploy)
      - name: üíæ Cache Composer packages
        id: composer-cache
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      # 4. Instala Depend√™ncias (Cria a pasta /vendor)
      - name: üì¶ Install Composer Dependencies
        run: composer install --no-dev --optimize-autoloader --prefer-dist --no-progress

      # ----------------------------------------------------------------
      # PARTE 1: Envia o BACKEND (App, Vendor, Config) via FTP
      # ----------------------------------------------------------------
      - name: üìÇ Deploy Backend (App Core)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: repertorio-app/
          # Exclui a pasta public daqui (ela vai separada depois)
          exclude: |
            public/**
            .git*
            .github/**
            tests/**
            storage/*.key
            .env
            /README.md

      # ----------------------------------------------------------------
      # PARTE 2: Envia o FRONTEND (CSS/JS da pasta public) via FTP
      # ----------------------------------------------------------------
      - name: üìÇ Deploy Frontend (Public Folder)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: public/
          server-dir: repertorio.websiteponto.com.br/
          exclude: |
            index.php

      # ----------------------------------------------------------------
      # PARTE 3: Roda as Migrations via SSH
      # ----------------------------------------------------------------
      - name: üöÄ Run Migrations via SSH
        uses: appleboy/ssh-action@master
        with:
          # Usa as mesmas credenciais do FTP (geralmente funcionam para SSH)
          host: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: 22 # Porta padr√£o do SSH (se for diferente, altere aqui)
          
          # O Script que ser√° digitado no terminal do servidor
          script: |
            cd repertorio-app
            
            # (Opcional) Coloca em modo manuten√ß√£o r√°pido
            # php artisan down 

            # Roda as migrations for√ßando produ√ß√£o
            php artisan migrate --force
            
            # Limpa caches para evitar erros de config antiga
            php artisan config:clear
            php artisan route:clear
            php artisan view:clear
            
            # (Opcional) Volta o site
            # php artisan up