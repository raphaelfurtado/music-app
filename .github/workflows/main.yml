name: ğŸš€ Deploy Completo (Backend + Frontend Separados)

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: ğŸ‰ Deploy Production
    runs-on: ubuntu-latest
    
    steps:
      # 1. Baixa o cÃ³digo
      - name: ğŸšš Get latest code
        uses: actions/checkout@v4

      # 2. Configura o PHP
      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo_mysql

      # 3. Cache do Composer
      - name: ğŸ’¾ Cache Composer packages
        id: composer-cache
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      # 4. Instala DependÃªncias (Cria a pasta /vendor)
      - name: ğŸ“¦ Install Composer Dependencies
        run: composer install --no-dev --optimize-autoloader --prefer-dist --no-progress

      # ----------------------------------------------------------------
      # PARTE 1: Envia o BACKEND (App, Vendor, Config)
      # ----------------------------------------------------------------
      - name: ğŸ“‚ Deploy Backend (App Core)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          
          # Destino: Pasta protegida do sistema
          server-dir: repertorio-app/
          
          # Exclui a pasta public daqui (pois ela vai para outro lugar no passo seguinte)
          exclude: |
            public/**
            .git*
            .github/**
            tests/**
            storage/*.key
            .env
            /README.md

      # ----------------------------------------------------------------
      # PARTE 2: Envia o FRONTEND (CSS, JS, Assets)
      # ----------------------------------------------------------------
      - name: ğŸ“‚ Deploy Frontend (Public Folder)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          
          # Origem: Sua pasta public local
          local-dir: public/
          
          # Destino: Sua pasta pÃºblica no servidor (SubdomÃ­nio)
          server-dir: repertorio.websiteponto.com.br/
          
          # IMPORTANTE: 
          # Geralmente excluÃ­mos o index.php se o do servidor jÃ¡ estiver 
          # configurado com os caminhos corretos (../repertorio-app/...).
          # Se o index.php do seu git jÃ¡ estiver certo, pode remover essa linha de exclude.
          exclude: |
            index.php

      # ----------------------------------------------------------------
      # PARTE 3: Roda as Migrations (Gatilho via URL)
      # ----------------------------------------------------------------
      - name: ğŸš€ Trigger Database Migrations
        run: curl https://repertorio.websiteponto.com.br/rodar-migrations-secreto?key=123456